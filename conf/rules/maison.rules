// Rule: Turn on the light when motion is detected (if manual switch is off)
rule "Turn on light when motion detected"
when
    Item Simulated_MotionSensor changed to ON
then
    if (Manual_Light_Switch.state == OFF) { // Only turn on if manual switch is off
        logInfo("MotionRule", "Motion detected, turning on the light.")
        Light_Controlled.sendCommand(ON)
    }
end

// Rule: Turn off the light after inactivity (if manual switch is off)
rule "Turn off light after inactivity"
when
    Item Simulated_MotionSensor changed to OFF
then
    logInfo("MotionRule", "No motion detected, setting a timer to turn off the light.")
    createTimer(now.plusMinutes(1)) [ |
        if (Simulated_MotionSensor.state == OFF && Manual_Light_Switch.state == OFF) {
            logInfo("MotionRule", "Turning off the light after inactivity.")
            Light_Controlled.sendCommand(OFF)
        }
    ]
end

// Rule: Manual light control (turn light on/off regardless of motion)
rule "Manual light control"
when
    Item Manual_Light_Switch changed
then
    if (Manual_Light_Switch.state == ON) {
        logInfo("ManualControl", "Manual switch turned on, turning on the light.")
        Light_Controlled.sendCommand(ON)
    } else {
        logInfo("ManualControl", "Manual switch turned off, turning off the light.")
        Light_Controlled.sendCommand(OFF)
    }
end

// Rule: Turn off the light after inactivity (1 minute after motion stops, if manual switch is off)
rule "Turn off light after inactivity"
when
    Item Simulated_MotionSensor changed to OFF
then
    logInfo("MotionRule", "No motion detected, setting a timer to turn off the light.")
    createTimer(now.plusMinutes(1)) [ |
        // Check if there is still no motion and manual switch is OFF
        if (Simulated_MotionSensor.state == OFF && Manual_Light_Switch.state == OFF) {
            logInfo("MotionRule", "Turning off the light after inactivity.")
            Light_Controlled.sendCommand(OFF)
        }
    ]
end


// Rule: Turn off lights after midnight
rule "Turn off lights after midnight"
when
    Time cron "0 0 0 * * ?" // Trigger at midnight
then
    if (Light_Controlled.state == ON) {
        logInfo("MidnightRule", "It is midnight, turning off the lights.")
        Light_Controlled.sendCommand(OFF)
    }
end



// Rule: Trigger alert when door sensor detects an intrusion
rule "Door intrusion alert"
when
    Item Simulated_DoorSensor changed to ON
then
    logInfo("IntrusionAlert", "Intrusion detected: Door sensor triggered!")
    Intrusion_Alert.sendCommand(ON)
end

// Rule: Trigger alert when window sensor detects an intrusion
rule "Window intrusion alert"
when
    Item Simulated_WindowSensor changed to ON
then
    logInfo("IntrusionAlert", "Intrusion detected: Window sensor triggered!")
    Intrusion_Alert.sendCommand(ON)
end

// Rule: Reset the intrusion alert manually
rule "Reset intrusion alert"
when
    Item Intrusion_Alert changed to OFF
then
    logInfo("IntrusionAlert", "Intrusion alert reset.")
end
/////////////////////////////////////////////////////////////d////////////////////////////
val TAG_FileName = "maison.rules"
val notification_email = "projetift7132024idmnw@proton.me"
rule "Démarrage de openHAB"
when
    System started
then
    logInfo(TAG_FileName, "Rule : Démarrage de openHAB")
    mouvement.postUpdate(OFF)
    porte.postUpdate(OFF)
    fenetre.postUpdate(OFF)
    waterLevel.postUpdate(0)
end
rule "Test de notification"
when
    Item notification changed to ON
then
    sendNotification(notification_email, "Test")
    notification.postUpdate(OFF)
end
rule "Notification de mouvement"
when
    Item mouvement changed to ON
then
    sendNotification(notification_email, "Mouvement détecté")
    mouvement.postUpdate(OFF)
end
rule "Notification de porte"
when
    Item porte changed
then
    if (porte.state == ON) {
        sendNotification(notification_email, "Porte ouverte")
    } else {
        sendNotification(notification_email, "Porte fermée")
    }
end
rule "Notification de fenêtre"
when
    Item fenetre changed
then
    if (fenetre.state == ON) {
        sendNotification(notification_email, "Fenêtre ouverte")
    } else {
        sendNotification(notification_email, "Fenêtre fermée")
    }
end
rule "Notification de niveau d'eau"
when
    Item waterLevel changed
then
    val seuilNiveauEau = 5
    if ((waterLevel.state as Number) >= seuilNiveauEau) {
        sendNotification(notification_email, "Niveau d'eau élevé : " + waterLevel.state.toString + " mm")
    }
end

/////////////////////////////////////////////////
val TAG_FileName = "maison.rules"
rule "Démarrage de openHAB"
when
System started
then
logInfo(TAG_FileName, "Rule : Démarrage de openHAB")

logInfo(TAG_FileName, "Rule : alert niveau d'eau")
rule "Water Level Alert"
when
    Item WaterLevel changed
then
    if (WaterLevel.state >10) {
        //notifictaion

    } 
end
//auto-diagonistic
rule "Exécution toutes les 5 secondese"
 when 
Time cron "0/5 * * * * ?" 
then 
logInfo("CronExample", "La règle est exécutée à " + now.toString)

// Capteur hors 
if (Thing "mqtt:temperatureSensor:1234" changed to OFFLINE ){
//notification
// auto-configuraton
}
if (Thing "mqtt:temperatureSensor:1234" changed to OFFLINE ){
//notification
// auto-configuraton
}
if (Thing "mqtt:temperatureSensor:1234" changed to OFFLINE ){
//notification
// auto-configuraton
}
if (Thing "mqtt:temperatureSensor:1234" changed to OFFLINE ){
//notification
// auto-configuraton
}


 end


rule "Détection de capteur hors ligne"
when
    Thing "mqtt:temperatureSensor:1234" changed to OFFLINE  // Capteur hors 